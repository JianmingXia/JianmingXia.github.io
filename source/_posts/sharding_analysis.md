---
title: 分库分表分析
date: 2018/09/03 21:00:00
tags:
  - MySQL
  - 分库分表
categories: MySQL
---

## 说在前面

> 数据库：database
>
> 数据表：table
>
> 分库分表：sharding

关系型数据库本身比较容易成为系统性能瓶颈，单机存储容量、连接数、处理能力等都很有限，数据库本身的“有状态性”导致它并不能像Web和应用服务器那么容易扩展。

<!-- more -->

## 分表策略

### 垂直分表

#### 策略

大表拆小表——基于数据库中的"列"字段，通常情况，当某个表中的字段比较多时，可以新建一个“扩展表”，将不经常使用或者长度较大的字段拆分，移至“扩展表”中。

#### 分析

在字段很多的情况下，拆分更便于开发和维护。另外，某种程度上也能避免“跨页”的问题。

拆分字段的操作建议再数据表设计阶段就做好，如果在发展中拆分，则需要改之前的查询语句，会带来一定的成本和风险。

### 垂直分库

#### 策略

垂直分库在“微服务”盛行的今天已经非常普及了——基本的思路是按照业务模块来划分出不同的数据库，而不是像早期一样将所有的数据表全放在一个数据库中。

#### 分析

从系统层面进行拆分，能够解决业务系统层面的耦合和性能瓶颈，有利于系统的扩展维护。而在数据库层面，道理也是如此。

数据库往往最容易成为应用系统的瓶颈，而数据库本身是“有状态”的，相对于Web和应用服务器来说，比较难以实现“横向扩展”。数据库的连接资源比较宝贵且单机能力也有限，在高并发场景下，垂直分库一定程度上能够突破IO、连接数及单机硬件资源的瓶颈。

需要注意的是，不要盲目拆分，导致产生了跨库join、分布式事务等这些问题。

### 水平分表

#### 策略

水平分表又称横向分表——将表中的行数据按照一定规则分布到不同的数据表中（在同一数据库），这样来降低单表数据量，优化查询性能。

最常见的做法是通过主键或者时间等字段进行Hash和取模后拆分

#### 分析

水平分表能够降低单表的数据量，一定程度上可以缓解查询性能瓶颈，但本质上这些表还保存在同一个表中，所以库级别还是会有IO瓶颈，一般不建议采用此方法。

### 水平分库分表

#### 策略

与“水平分表”类似，唯一不同的是拆分出来的表保存在不同的数据库中。

某种意义上来说，“冷热数据分离”也是类似的时间。在高并发和海量数据的场景下，分库分表能够有效的缓解单机和单库的性能瓶颈及压力。

#### 分析

分库分表首先带来的是投入成本；同时，也会有一些技术难点，比如跨库的复杂查询、分布式事务等

## 分库分表带来的难点

### 跨库join的问题

当我们执行分库分表策略后，如果有join操作会变得极其麻烦，甚至很多架构规范，一般是禁止跨库join的。此时首先考虑分库的设计问题，如果可以调整，那就优先调整。

#### 全局表

有可能是系统中所有模块都可能会依赖的一些表，为了避免跨库join查询，可以将这类数据在每个数据库中都存储一份。因为这类数据一般很少发生修改，不用过于担心“一致性”。

#### 字段冗余

这是一种典型的反范式设计，为了提高性能来避免join查询。

比如在电商业务中：“订单表”中保存“卖家ID”的同时，将卖家的”name“字段也冗余，这样避免在查询订单详情时再查询”卖家用户表“

字段冗余能带来便利，是一种“空间换时间”的提现。另外， 还需要考虑到：

- 适用场景有限，适合依赖字段较少的情况
- 数据一致性很难保证

#### 数据同步

定时同步指定的表，但是需要考虑到：

- 同步本身会对数据库带来一定的影响，在性能以及数据时效性上需要做一个平衡

#### 系统层组装

在系统层面，调用不同模块的组件或服务，获取到指定数据并进行拼接。

切忌循环RPC、循环查询数据库

#### ER分片

将存在关联的表放在同一个分片上，避免跨分片join的问题

#### 内存计算

可以将数据丢到spark集群中进行内存计算

### 跨库事务的问题

分库之后，不可避免的就是分布式事务的问题，可参考[文档](http://www.infoq.com/cn/articles/solution-of-distributed-system-transaction-consistency)

- XA接口

- 两阶段提交

### 分布式全局唯一ID

我们经常会使用数据库自增特性来生成主键ID，这种确实比较简单。但在分库分表的环境中，数据分布在不同的分片上，无法再借助数据库自增长特性直接生成，否则会造成不同分片上的数据表主键重复，了解一下ID生成算法：

- Twitter的Snowflake（雪花算法）
- UUID/GUID（一般的数据库/应用程序都支持）
- MongoDB ObjectID（类似UUID的方式）
- Ticket Server（数据库生成方式，flickr采用的方式）

### 分片字段如何选择

在开始分片之前，我们需要确定分片字段。很多常见的场景都是采用ID或者时间字段做区分，其实更推荐结合实际业务，通过统计分析，选择需要分片的那个表中最频繁使用或最重要的字段来作为分片字段。

#### 常见分片规则

- 连续分片
  - 当需要使用分片字段进行范围查询时，连续分片可以快速定位分片进行高效查询，在大部分情况下可以有效避免跨分片查询的问题
  - 后期如果希望对分片集群扩容时，只需要添加节点即可，无需对其他分片的数据进行迁移
  - 可能存在数据热点的问题，有些节点可能会被频繁查询压力较大，热数据节点成为整个集群的瓶颈；有些节点存储的是历史数据，很少会被查询
- 随机分片
  - 随机分片并不是随机，也遵循一定规则。通常，我们会使用Hash取模的方式进行分片拆分，有时候被称为离散分片
  - 随机分片的数据相对来说比较均匀，不容易出现热点和并发访问的瓶颈
  - 后期分片集群扩容需要迁移旧的数据——使用一致性Hash算法能够很大程度上避免这个问题，所以很多中间件的分片集群都会使用一致性Hash算法
  - 离散分片也很容易面临跨分片查询问题

#### 数据迁移、容量规划、扩容等

很少有项目在初期就考虑分片设计的，一般都是在业务高速发展面临性能和存储的瓶颈时才会准备——考虑历史数据的迁移问题——通过程序读出历史数据，再按照指定的分片规则，再将数据写入各个分片节点中。

如果是连续分片，只需要添加节点时就可以扩容。

如果是随机分片，需要考虑后期的扩容问题，相对于连续分片来说，会麻烦一些。

### 跨分片的排序分页

分页时按照指定字段进行排序，当排序字段就是分片字段是，可以通过分片规则就定位到指定分片；当排序字段非分片字段时，需要在不同的节点中将数据进行排序并返回，最终将不同分片的结果集进行汇总（汇总时需要主要数据，不要想当然）。

### 跨分片的函数处理

在使用Max、Min、Sum、Count之类的函数进行计算时，需要在每个分片上执行相应的函数处理，再进行汇总做二次处理，最后将最终结果返回。

## 其它问题

### 如何判断是否需要进行垂直分库？

根据系统架构和公司实际情况来，如果系统还是简单的单体应用，且访问量和数据量都很低，不要着急折腾“垂直分库”，没有人任何收益。

切忌“过度设计”和“过早优化”

### 垂直拆分有没有原则或技巧？

没有什么黄金法则或标准答案。一般参考系统的业务模块拆分来进行数据库的拆分，如何设计与权衡，要看实际情况。

### 后台报表系统中join的表都n个了，分库后该怎么查？

在互联网的业务系统中，本来应该尽量避免join，如果有多个join，要么是设计不合理，或是技术选型有误。

## 关键字

以下是一些需要了解的关键字：

- 跨页——MySQL底层通过“数据页”来存储，“跨页”可能会导致额外的性能开销
- OLAP——On-Line Analytical Processing：强调数据库内存效率，强调内存各种指标的命令率，强调绑定变量，强调并发操作
- OLTP——On-Line Transaction Processing：强调数据分析，强调SQL执行市场，强调磁盘I/O，强调分区等
- 一致性Hash算法
- 过度技术——表分区

## 参考

- http://www.infoq.com/cn/articles/key-steps-and-likely-problems-of-split-table
- http://www.infoq.com/cn/articles/key-steps-and-likely-problems-of-horizontal-split-table
---
title: Redis 规范
date: 2018/07/29 11:00:00
tags:
  - Redis
categories: Redis
---

> redis不是垃圾桶也不是 SUPER MAN，能力和资源都有限，不合理的使用会降低它的健康度，严重时甚至会引起redis抖动、阻塞等进而导致服务不可用，每一个使用redis的开发人员都应当掌握规范的开发和使用方法。

## 键值设计
### key 设计
#### 可读性
以业务名(或数据库名)为前缀，用冒号分隔
格式：业务名：子业务名：id

eg：活动系统-人拉人红包活动-id
```
ACTIVITY:INVITE_REDPACKET:001
```
<!-- more -->

#### 简洁性
保证语义的前提下，控制key的长度，当key较多时，内存占用也不容忽视

#### 不包含转义字符
不包含空格、换行、单双引号以及其他转义字符

### value 设计
#### 拒绝大值
- string类型尽量控制在10KB以内
- hash、list、set、zset元素个数不要超过5000

虽然redis对单个key可以缓存的对象长度能够支持的很大，但是实际使用场合一定要合理拆分过大的缓存项，1k 基本是redis性能的一个拐点。

#### 选择适合的数据类型
- 错误的使用姿势：
```
set user:1:name tom
set user:1:age 19
set user:1:favor football
```

- 正确的使用姿势：
```
hmset user:1 name tom age 19 favor football
```

#### 合理设置过期时间
redis不是垃圾桶，建议使用expire设置过期时间(条件允许可以打散过期时间，防止集中过期)，不过期的数据重点关注idletime。
如果key没有设置超时时间，会导致一直占用内存。
对于可以预估使用生命周期的key应当设置合理的过期时间或在最后一次操作时进行清理，避免垃圾数据残留redis。

## 命令使用
### 禁用命令
- keys
- monitor
- flushall
- flushdb

应当通过redis的rename机制禁掉命令。

若没有禁用，开发人员要谨慎使用。其中flushall、flushdb会清空redis数据；keys命令可能会引起慢日志；monitor命令在开启的情况下会降低redis的吞吐量，根据压测结果大概会降低redis50%的吞吐量，越多客户端开启该命令，吞吐量下降会越多。

### O(N)命令关注N的数量
例如hgetall、lrange、smembers、zrange、sinter等。
以上命令并非不能使用，但是需要明确N的值，有遍历的需求可以使用hscan、sscan、zscan代替。

### 合理使用select
redis的多数据库较弱，使用数字进行区分，很多客户端支持较差，同时多业务用多数据库实际还是单线程处理，会有干扰。

### 合理利用批操作命令
在redis使用过程中，要正视网络往返时间，合理利用批量操作命令，减少通讯时延和redis访问频次。redis为了减少大量小数据CMD操作的网络通讯时间开销 RTT (Round Trip Time)，支持多种批操作技术：
- MSET/HMSET等都支持一次输入多个key，LPUSH/RPUSH/SADD等命令都支持一次输入多个value,也要注意每次操作数量不要过多,建议控制在500个以内；
- PipeLining 模式 可以一次输入多个指令。redis提供一个 pipeline 的管道操作模式，将多个指令汇总到队列中批量执行，可以减少tcp交互产生的时间，一般情况下能够有10%~30%不等的性能提升；
- 更快的是Lua Script模式，还可以包含逻辑。redis内嵌了 lua 解析器，可以执行lua 脚本，脚本可以通过eval等命令直接执行，也可以使用script load等方式上传到服务器端的script cache中重复使用。

### Redis事务功能较弱，不建议过多使用
Redis的事务功能较弱(不支持回滚)

## 客户端使用
### 避免多个应用使用一个Redis实例
将不相干的业务拆分，减少不同业务相互操作的影响，提高请求响应速度

### 连接池使用
可以有效控制连接，同时提高效率

### 设置密码

## 使用场景分析
### 冷热数据分离，不要将所有数据全部都放到Redis中

### 使用多个键存储同一对象
尽管使用多个键存储同一对象就使得使用一个键和索引号来进行访问时带来便利，但是当缓存是基于远程缓存的话，任何关于对象改变都是不可见的，这样会导致缓存数据同步问题的发生

### 内存使用分析
我们要买的Redis实例一般会是8G，在使用Redis之前，内存的占用一定要心里有数。

### 常见使用场景
#### 计数器
数据统计的需求非常普遍，通过原子递增保持计数。例如，点赞数、收藏数、分享数等。

#### 排行榜
排行榜按照得分进行排序，例如，展示最近、最热、点击率最高、活跃度最高等等条件的top list。

#### 记录用户判定信息
记录用户判定信息的需求也非常普遍，可以知道一个用户是否进行了某个操作。例如，用户是否点赞、用户是否收藏、用户是否分享等。

#### 社交列表
社交属性相关的列表信息，例如，用户点赞列表、用户收藏列表、用户关注列表等。

#### 缓存
缓存一些热点数据，例如，PC版本文件更新内容、资讯标签和分类信息、生日祝福寿星列表。

#### 会话缓存
使用Redis进行会话缓存。例如，将web session存放在Redis中。

#### 队列
Redis能作为一个很好的消息队列来使用，通过list的lpop及lpush接口进行队列的写入和消费，本身性能较好能解决大部分问题。但是，不提倡使用，更加建议使用rabbitmq等服务，作为消息中间件。

## 资料
- https://yq.aliyun.com/articles/531067?spm=5176.10695662.1996646101.searchclickresult.411a3928fBKcPk
- http://www.infoq.com/cn/news/2014/09/ten-cache-misunderstanding
- https://mp.weixin.qq.com/s/_5fzR6xDqZhOvv-bKuJzGg
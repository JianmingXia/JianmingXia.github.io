---
title: Cocos2d-html5 plist优化 & plist文件加载解析
date: 2018/5/5 12:00:00
tags:
  - Ant Design
  - dva
  - Electron
categories: 技术杂集
---

> 目前h5引擎正在处于研究阶段，基于Cocos2d-html5封装一个TS版的引擎库。

## 说在前面
之前在封装UI及Scene这块的内容，UI部分涉及到加载素材，也了解到cocos可以直接使用TexturePacker合成后的plist文件及png。但是对于H5的项目来说，减少网络请求是很重要的一步，特别是在页面初始化加载的时候。这时候在官网看到如下内容：[cc.spriteFrameCache 改造说明](http://www.cocos.com/docs/html5/v3/cc-spriteframecache/zh.html)
通俗来说，就是在知道SpriteFrame的数据结构之后，提前将plist文件的解析(这样可以做到将多个plist文件集合到一个文件中，减少加载次数）。官网有一个做法：
<!-- more -->
- 提取n个plist文件至一个xx.pkgJson文件中，文件加载完毕后，使用自定义的_pkgJsonLoader对文件内容再次处理

我在按照此方法的处理过程中，发现_pkgJsonLoader中对数据结构处理的很少，只是做了数据提取部分。所以个人觉得在生成.pkgJson文件时，就可以直接按照SpriteFrame数据结构来生成数据，没有必要经过两次处理。以下是官网提供的思路：
<a id="more"></a>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// SpriteFrame数据结构</div><div class="line">&#123;</div><div class="line">    _inited : true,</div><div class="line">    frames : &#123;</div><div class="line">        &quot;a_frame_0.png&quot; : &#123;</div><div class="line">            rect : &#123;x : 0, y : 0, width : 1, height : 1&#125;,</div><div class="line">            rotated : false,</div><div class="line">            offset : &#123;x : 0, y : 0&#125;,</div><div class="line">            size : &#123;width : 1, height : 1&#125;</div><div class="line">            aliases : [&quot;a_f_0&quot;]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    meta : &#123;</div><div class="line">        image : &quot;a.png&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">// pkgJsonLoader核心代码</div><div class="line">cc._pkgJsonLoader = &#123;</div><div class="line">    /**</div><div class="line">     * @constant</div><div class="line">     */</div><div class="line">    _parse : function(data)&#123;</div><div class="line">        var KEY = data instanceof Array ? this.MIN_KEY : this.KEY;</div><div class="line">        var frames = &#123;&#125;, meta = data[KEY.meta] ? &#123;image : data[KEY.meta][KEY.image]&#125; : &#123;&#125;;</div><div class="line">        var tempFrames = data[KEY.frames];</div><div class="line">        for (var frameName in tempFrames) &#123;</div><div class="line">            var f = tempFrames[frameName];</div><div class="line">            var rect = f[KEY.rect];</div><div class="line">            var size = f[KEY.size];</div><div class="line">            var offset = f[KEY.offset];</div><div class="line">            frames[frameName] = &#123;</div><div class="line">                rect : &#123;x : rect[0], y : rect[1], width : rect[2], height : rect[3]&#125;,</div><div class="line">                size : &#123;width : size[0], height : size[1]&#125;,</div><div class="line">                offset : &#123;x : offset[0], y : offset[1]&#125;,</div><div class="line">                rotated : f[KEY.rotated],</div><div class="line">                aliases : f[KEY.aliases]</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return &#123;_inited : true, frames : frames, meta : meta&#125;;</div><div class="line">    &#125;,</div><div class="line">    load : function(realUrl, url, res, cb)&#123;</div><div class="line">        var self = this, locLoader = cc.loader, cache = locLoader.cache;</div><div class="line">        locLoader.loadJson(realUrl, function(err, pkg)&#123;</div><div class="line">            if(err) return cb(err);</div><div class="line">            var dir = cc.path.dirname(url);</div><div class="line">            for (var key in pkg) &#123;</div><div class="line">                var filePath = cc.path.join(dir, key);</div><div class="line">                cache[filePath] = self._parse(pkg[key]);</div><div class="line">            &#125;</div><div class="line">            cb(null, true);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="cocos-pkgjson"><a href="#cocos-pkgjson" class="headerlink" title="cocos-pkgjson"></a><a href="https://www.npmjs.com/package/cocos-pkgjson" target="_blank" rel="external">cocos-pkgjson</a></h2><p>上面说了那么多，首先需要解决的是plist数据解析的工具，可惜在官网上只提供了解析后的数据结构，没有解析工具。为此我在中文论坛及其它相关论坛都问了一遍，但是没有得到满意的答复。所以，决定自己造个轮子。我在npm上找到了plist包，试用了之后，发现plist可以将plist文件的数据提取出来，数据结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;frames&quot;: &#123;</div><div class="line">        &quot;0.png&quot;: &#123;</div><div class="line">            &quot;aliases&quot;: [</div><div class="line">                </div><div class="line">            ],</div><div class="line">            &quot;spriteOffset&quot;: &quot;&#123;0,0&#125;&quot;,</div><div class="line">            &quot;spriteSize&quot;: &quot;&#123;64,49&#125;&quot;,</div><div class="line">            &quot;spriteSourceSize&quot;: &quot;&#123;64,49&#125;&quot;,</div><div class="line">            &quot;textureRect&quot;: &quot;&#123;&#123;1,55&#125;,&#123;64,49&#125;&#125;&quot;,</div><div class="line">            &quot;textureRotated&quot;: false</div><div class="line">        &#125;,</div><div class="line">        &quot;1.png&quot;: &#123;</div><div class="line">            &quot;aliases&quot;: [</div><div class="line">                </div><div class="line">            ],</div><div class="line">            &quot;spriteOffset&quot;: &quot;&#123;0,0&#125;&quot;,</div><div class="line">            &quot;spriteSize&quot;: &quot;&#123;67,52&#125;&quot;,</div><div class="line">            &quot;spriteSourceSize&quot;: &quot;&#123;67,52&#125;&quot;,</div><div class="line">            &quot;textureRect&quot;: &quot;&#123;&#123;1,1&#125;,&#123;67,52&#125;&#125;&quot;,</div><div class="line">            &quot;textureRotated&quot;: false</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;metadata&quot;: &#123;</div><div class="line">        &quot;format&quot;: 3,</div><div class="line">        &quot;pixelFormat&quot;: &quot;RGBA8888&quot;,</div><div class="line">        &quot;premultiplyAlpha&quot;: false,</div><div class="line">        &quot;realTextureFileName&quot;: &quot;radio.png&quot;,</div><div class="line">        &quot;size&quot;: &quot;&#123;69,105&#125;&quot;,</div><div class="line">        &quot;smartupdate&quot;: &quot;$TexturePacker:SmartUpdate:305947cb63527c2d3a81c456831d3508:0ffe9fa733c7901a53ebea001548ed6d:eed519fbbdd46973eb5ec3b717bd80b1$&quot;,</div><div class="line">        &quot;textureFileName&quot;: &quot;radio.png&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实，到了这一步，我要做的东西就很简单了。基于plist转换后的结构，提取出SprimeFrame需要的数据即可。提取结果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;_inited&quot;: true,</div><div class="line">    &quot;frames&quot;: &#123;</div><div class="line">        &quot;0.png&quot;: &#123;</div><div class="line">            &quot;rect&quot;: &#123;</div><div class="line">                &quot;x&quot;: 1,</div><div class="line">                &quot;y&quot;: 55,</div><div class="line">                &quot;width&quot;: 64,</div><div class="line">                &quot;height&quot;: 49</div><div class="line">            &#125;,</div><div class="line">            &quot;rotated&quot;: false,</div><div class="line">            &quot;offset&quot;: &#123;</div><div class="line">                &quot;x&quot;: 0,</div><div class="line">                &quot;y&quot;: 0</div><div class="line">            &#125;,</div><div class="line">            &quot;size&quot;: &#123;</div><div class="line">                &quot;width&quot;: 64,</div><div class="line">                &quot;height&quot;: 49</div><div class="line">            &#125;,</div><div class="line">            &quot;aliases&quot;: [</div><div class="line">                </div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &quot;1.png&quot;: &#123;</div><div class="line">            &quot;rect&quot;: &#123;</div><div class="line">                &quot;x&quot;: 1,</div><div class="line">                &quot;y&quot;: 1,</div><div class="line">                &quot;width&quot;: 67,</div><div class="line">                &quot;height&quot;: 52</div><div class="line">            &#125;,</div><div class="line">            &quot;rotated&quot;: false,</div><div class="line">            &quot;offset&quot;: &#123;</div><div class="line">                &quot;x&quot;: 0,</div><div class="line">                &quot;y&quot;: 0</div><div class="line">            &#125;,</div><div class="line">            &quot;size&quot;: &#123;</div><div class="line">                &quot;width&quot;: 67,</div><div class="line">                &quot;height&quot;: 52</div><div class="line">            &#125;,</div><div class="line">            &quot;aliases&quot;: [</div><div class="line">                </div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;meta&quot;: &#123;</div><div class="line">        &quot;image&quot;: &quot;radio.png&quot;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>配合自定义的cc._pkgJsonLoader:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">cc._pkgJsonLoader = &#123;</div><div class="line">    load: function (realUrl, url, res, cb) &#123;</div><div class="line">        var self = this, locLoader = cc.loader, cache = locLoader.cache;</div><div class="line">        locLoader.loadJson(realUrl, function (err, pkg) &#123;</div><div class="line">            if (err) return cb(err);</div><div class="line">            var dir = cc.path.dirname(url);</div><div class="line">            for (var key in pkg) &#123;</div><div class="line">                var filePath = cc.path.join(dir, key);</div><div class="line">                cache[filePath] = pkg[key];</div><div class="line">            &#125;</div><div class="line">            cb(null, true);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">cc.loader.register([&quot;pkgJson&quot;], cc._pkgJsonLoader);</div></pre></td></tr></table></figure></p>

## 问题解析
### 可能不了解的人会有疑问，为什么plist经过此处理就可以直接使用了，有什么优点呢？
其实之前提到过一部分，在此重点再说一次：
- 减少网络请求——原先游戏在启动时，要将plist文件全部加载完成（不清楚到底有多少个），现在讲n个plist集成到一个.pkgJson文件中，一次网络请求即可
- 避免解析数据——原有的plist文件加载完成后，底层还需要再次解析，而现在，.pkgJson中的内容就是直接可用的

### cocos加载png plist时发生了什么
这部分是在和同事交流时发现一位使用了cocos很久的开发，对此过程中到底发生了什么也不太了解。
#### png(其它图片资源也是同样的情况)
- 发起加载png资源的请求
- cc.loader.cache缓存对应数据
- cc.textureCache._textures缓存对应数据

#### plist
- 发起加载plist资源的请求
- cc.loader.cache缓存对应数据

此时，cc.loader.cache存储的还是xml中的内容：
当我们使用如下命令是：<code>cc.spriteFrameCache.addSpriteFrames(&quot;xx.plist&quot;);</code>

- 获取plist对应的内容
    - 未初始化：解析数据，解析完数据后添加：<code>&quot;_inited&quot;: true</code>属性，标记解析完成
    - 已初始化：直接使用数据
- 从plist对应的图片资源中加载资源（这个时候使用cc.textureCache._textures，如果没有数据，会发起一次网络请求）
- 将spriteFrame存储至_spriteFrames;

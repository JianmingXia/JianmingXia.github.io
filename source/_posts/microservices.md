---
title: 微服务的模式语言
date: 2017/11/31 12:00:00
tags:
  - 微服务
categories: 未分类
---

# 微服务架构

## 核心模式
### 需求
- 应用需要由一个开发者团队专门负责
- 团队新成员需要快速上手
- 应用应该易于理解和修改
- 对应用能够进行持续部署
- 需要在多台设备上运行应用副本，从而满足可扩展性与可用性的要求
- 使用各种新技术（框架、编程语言等）

### 单体架构——采用单一部署单元的方式架构应用
- 优势
	- 易于开发
	- 易于部署
	- 易于拓展

<!-- more -->

- 弊端
	- 单体应用愈加庞大的代码库
	- 过载的IDE
	- 过载的web容器
	- 持续部署困难
	- 应用拓展困难——单体架构只能进行一维伸缩。一方面，它可以通过运行多个应用副本来增加业务容量，实现扩展。一些云服务甚至可以根据负载量动态调整实例数量。但在另一方面，数据量增大会使得该架构无法伸缩。每个应用实例需要访问所有数据，导致缓存低效，加大内存占用和I/O流量。另外，不同的应用组件有不同的资源需求——有的是CPU密集型的，另外一些是内存密集型的。单体架构无法单独伸缩每个组件
	- 难于进行规模化开发——单体应用是规模化开发的障碍。应用一旦达到特定规模，需要将现有组织拆分成多个团队，每个团队负责不同的功能模块。举例来说，我们可能需要设立UI团队、会计团队、库存团队等等。单体应用的问题在于它使团队无法独立展开工作。团队需要在工作进度和重新部署上进行协调。对于各团队而言，这使得变更和更新产品变得异常困难。
	- 需要长期关注同一套技术栈

### 微服务架构——采用一组松耦合服务的方式架构应用
- 优势
	- 每项微服务相对较小
		- 易于开发者理解
		- IDE处理速度更快，可提高开发者生产效率
		- Web容器启动速度更快，提高开发者生产效率并可加快部署速度
	- 每项服务皆可独立于其它服务进行部署
	- 易于实现规模化开发，多团队可以共同进行开发工作
	- 改善故障隔离。如某一服务出现内存泄露情况
	- 无需长期使用同一套技术堆栈

- 弊端
	- 开发者必须应对创建分布式系统所产生的额外的复杂因素。
		- 现有开发者工具/IDE主要面向单体应用程序，因此无法显式支持分布式应用的开发
		- 测试工作更加困难
		- 开发者必须采取服务间通信机制
		- 很难在不使用分布式事务机制的情况下跨服务实现功能
		- 跨服务实现功能要求各团队进行密切协作
	- 部署复杂
	- 内存占用量更高——多服务器部署时，会有重复缓存

## 服务拆分
### 需求
- 架构必须稳定
- 服务必须有内聚性——应当实现一组强相关的功能
- 服务必须符合共同封闭原则——一起修改的内容必须打包在一起，确保只影响一个服务
- 服务必须低耦合
- 服务应当可测试
- 每个服务都应足够小，可以由"two pizza"队伍开发
- 每个由一个或多个服务的团队应当是自治的——有能力开发和部署服务

### 案例
- 产品目录
- 存货管理
- 订单管理
- 交付管理
- 。。。

### 根据业务能力拆分
- 优势
	- 由于业务稳定所以架构稳定
	- 开发团队是跨功能的、自治的，并围绕交付业务价值而不是技术特性进行组织
	- 服务高内聚 低耦合
	
- 有以下问题需要解决
	- 如何区分业务能力？

### 根据领域的子域拆分
- 优势
	- 子域相对稳定 故而 架构稳定
	- 开发团队是跨功能的、自治的，并围绕交付业务价值而不是技术特性进行组织
	- 服务高内聚 低耦合
- 有以下问题需要解决
	- 如何区分子域？
	- 组织架构——一个组织内的不同群组可能对应（不同）子域
	- 高级域模型

## 部署模式
### 需求
- 服务由多种语言、框架及框架版本编写
- 每个服务由多个服务实例组成，为了吞吐量和可用性
- 服务必须可独立部署及扩展
- 服务实例需要和其它的隔离
- 你需要快速编译和部署服务
- 你需要限制服务消耗的资源（CPU和内存）
- 你需要监听每个服务实例的行为
- 你希望部署可靠
- 你必须尽可能的高效部署应用

### 多服务实例部署在同一个主机上
如：部署多个服务实例在同一个JVM上

- 优势
	- 较于[单主机只部署单服务实例](#单主机只部署单服务实例)，更有效的利用资源

- 弊端
	- 有资源需求冲突的风险
	- 有依赖版本冲突的风险
	- 很难去限制单个服务实例消耗的资源
	- 很难去监控多个服务实例资源的消耗，不可能去隔离每个实例
	
### 单主机只部署单服务实例
- 优势
	- 多个服务实例之间相互隔离
	- 不可能出现资源引用或依赖版本冲突
	- 单服务实例最多消耗一个主机上的资源
	- 很直接的去监控、管理、重新部署单个服务实例
	
- 弊端
	- 与[多服务实例部署在同一个主机上](#多服务实例部署在同一个主机上)相比，资源利用率低很多——需要太多服务器

### 把服务的单一实例部署在它独享的虚拟机上
服务实例与虚拟机一一对应
如：	Netflix将每个服务打包成EC2 AMI，然后将每个服务实例部署为EC2实例
- 优势
	- 可以直接通过增加实例个数来扩展服务——Amazon自动缩放组甚至可以做到通过负载来自动调整
	- 虚拟机压缩了编译服务的技术细节——所有的服务都是如此，用相同的方式来启动和停止
	- 每个服务实例都是隔离的
	- 一个虚拟机可以限制服务实例的CPU和内存的消耗
	- IaaS解决方案，例如AWS提供了一个成熟的、功能丰富的部署和管理虚拟主机。例如：
		- 弹性负载均衡
		- 自动扩展组
		- 。。。

- 劣势
	- 构建虚拟机镜像很慢并且耗时
	
### 把服务的单一实例部署在它独享的容器上
服务实例与容器一一对应
如：将服务打包成一个（Docker）容器镜像，将每个服务作为一个容器部署

解决方法：
	[kubernetes](https://kubernetes.io/)
	[Marathon/Mesos](https://mesosphere.github.io/marathon/)
	[Amazon EC2 Container Service](https://amazonaws-china.com/cn/ecs/)

- 优势（前面四个优势与[把服务的单一实例部署在它独享的虚拟机上](#把服务的单一实例部署在它独享的虚拟机上)类似）
	- 直接通过改变容器实例的数量来扩展服务
	- 容器压缩了编译服务的技术细节——所有的服务都是如此，用相同的方式来启动和停止
	- 每个服务实例都是隔离的
	- 单个容器可以限制服务实例的CPU和内存的消耗
	- 容器构建及启动都非常快。例如：将应用打包为Docker容器比打包成AMI快100倍。Docker容器启动也比虚拟机快很多，因为只需要启动应用程序而不是整个系统。
	
- 弊端
	- 部署容器的基础设施不如部署虚拟机丰富

### 无服务部署
使用无服务器部署平台部署服务实例
使用一个部署基础设施：异常任何服务器概念（保留或预先分配的资源）——物理或虚拟主机，或容器。基础架构接收你服务的代码并允许它。根据每个请求消耗的资源付费。
例如：
[AWS Lambda](https://amazonaws-china.com/cn/lambda/)
[Google Cloud Functions](https://cloud.google.com/functions/docs/)
[Azure Functions](https://azure.microsoft.com/en-us/services/functions/)

- 优势
	- 减少了在管理底层基础设施无差异工作上花费的时间。相反，你可以专注与你的代码
	- 无服务部署架构非常具有弹性。可以根据服务的负载来自动扩展
	- 你为每个请求付费而不是虚拟机或容器
	
- 弊端
	- 重要的限制和约束——无服务化部署环境会有更多的约束，是基于虚拟机或容器的基础设施。例如：AWS Lambda只支持几种语言。只适合部署无状态的应用。不可以部署长时间运行有状态的应用，如数据库或消息代理。
	- 有限的“输入源”——lambads只会响应有限输入源。AWS不打算运行服务。例如，像RabbitMQ的订阅消息代理。
	- 应用必须快速启动——无服务化部署不适合服务需要长时间启动
	- 高延迟的风险——无法主动增加储备能力
	
### 服务部署平台
使用提供服务抽象化的高度自动化部署平台部署服务
使用部署平台，这是用于应用部署的自动化基础设施。提供了一个服务抽象化，这是一个被命名的，高度可用（负载均衡）服务实例的集合。
如（[参考原文](http://microservices.io/patterns/deployment/service-deployment-platform.html)）：
Docker编排框架
无服务化平台

## 需要关注的边界问题
如何处理服务实例与外界交互的问题？

### 微服务基底
一个用于服务实例与外界交互和简化服务开发的框架
- 需求
	- 创建微服务应当快 & 简单
	- 创建微服务时，必须处理横切的问题，例如：外部配置、日志、健康检查、服务注册及发现 等

案例：
- Java
	- Spring Boot and Spring Cloud
	- Dropwizard
- Go
	- Gizmo
	- Micro
	- Go kit
	
- 优势
	- 快速发布、简单开始

### 配置外部化
如数据库配置、认证 外部配置化

- 需求
	- 服务必须提供复制数据说明如何连接外部/第三方服务。如数据库配置、认证
	- 服务必须可以在多个环境中运行——dev test qa ——不需要修改或重新编译
	- 不同的环境有不同的外部/第三方服务实例

- 优势
	- 应用运行在多个环境中不需要修改或重新编译

- 存在的问题
	- 如何确保部署应用时提供的配置与期望的匹配
	
## 通讯模式
.....

## 参考文档
- http://microservices.io/patterns/